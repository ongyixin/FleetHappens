<!DOCTYPE html>
<!-- Part of Geotab Vibe Guide: https://github.com/fhoffa/geotab-vibe-guide -->
<!--
    Ace vs API Comparison Add-In

    DEBUGGING TIP: If HTML doesn't update after deploy, MyGeotab caches external URLs.
    Add a query param to force reload: change URL in Add-In config to
    https://fhoffa.github.io/geotab-vibe-guide/examples/addins/ace-api-comparison.html?v=2
    Increment ?v=3, ?v=4, etc. each time you need a fresh version.
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ace vs API Comparison v3.6</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
</head>
<body class="bg-light p-4">
    <div class="container">
        <h1 class="mb-1">Ace vs Direct API Comparison v3.6</h1>
        <p class="text-muted mb-4">Three tests demonstrating when to use each approach</p>

        <div class="alert alert-warning mb-4" role="alert">
            <strong>Note:</strong> Ace queries start 8s apart to avoid rate limits. API has a 5000 result limit per call.
        </div>

        <!-- Test 1: Speed -->
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center">
                <span class="fs-4 me-2">1️⃣</span>
                <div>
                    <h5 class="mb-0">Speed Test</h5>
                    <small class="text-muted">Same question, timing comparison</small>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info py-2 mb-3">
                    <small class="fw-bold">GOAL:</small> Count total vehicles in fleet<br>
                    <code class="text-success">API: GetCountOf Device</code><br>
                    <div class="mt-1 p-2 bg-warning-subtle border border-warning rounded">
                        <small class="fw-bold text-warning">Ace question:</small><br>
                        <code class="text-dark" style="font-size:11px;">"How many vehicles are in my fleet? Return a single column named vehicle_count."</code>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="bg-success-subtle border border-success rounded p-3">
                            <small class="fw-bold text-success">DIRECT API</small>
                            <div class="fs-3 fw-bold text-success" id="t1-api-status">Waiting...</div>
                            <small class="text-muted" id="t1-api-time">--</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-warning-subtle border border-warning rounded p-3" id="t1-ace-box">
                            <small class="fw-bold text-warning">ACE (Natural Language)</small>
                            <div class="fs-3 fw-bold text-warning" id="t1-ace-status">Queued...</div>
                            <small class="text-muted" id="t1-ace-time">--</small>
                        </div>
                    </div>
                </div>
                <pre class="bg-secondary-subtle p-2 rounded mt-2 small overflow-auto" style="max-height:300px;font-size:9px;" id="t1-debug"></pre>
            </div>
        </div>

        <!-- Test 2: Freshness -->
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center">
                <span class="fs-4 me-2">2️⃣</span>
                <div>
                    <h5 class="mb-0">Freshness Test</h5>
                    <small class="text-muted">Ace data can be hours behind real-time</small>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info py-2 mb-3">
                    <small class="fw-bold">GOAL:</small> Find most recent trip in fleet<br>
                    <code class="text-success">API: Get Trip (last 24h) → sort by stop time</code><br>
                    <div class="mt-1 p-2 bg-warning-subtle border border-warning rounded">
                        <small class="fw-bold text-warning">Ace question:</small><br>
                        <code class="text-dark" style="font-size:11px;">"What is the most recent trip in my fleet? Return columns: device_name, trip_end_time. Use UTC timezone."</code>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="bg-success-subtle border border-success rounded p-3">
                            <small class="fw-bold text-success">API (Real-time)</small>
                            <div id="t2-api-result" class="fw-bold" style="font-size:14px;">Waiting...</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-warning-subtle border border-warning rounded p-3" id="t2-ace-box">
                            <small class="fw-bold text-warning">ACE (Natural Language)</small>
                            <div id="t2-ace-result" class="fw-bold text-warning" style="font-size:14px;">Queued...</div>
                        </div>
                    </div>
                </div>
                <pre class="bg-secondary-subtle p-2 rounded mt-2 small overflow-auto" style="max-height:300px;font-size:9px;" id="t2-debug"></pre>
                <div id="t2-comparison" class="mt-2 p-2 rounded text-center d-none" style="background:#fef3c7;border:2px dashed #f59e0b;"></div>
            </div>
        </div>

        <!-- Test 3: Complex Analysis -->
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center">
                <span class="fs-4 me-2">3️⃣</span>
                <div>
                    <h5 class="mb-0">Complex Analysis</h5>
                    <small class="text-muted">Per-device trip queries vs Ace aggregate</small>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info py-2 mb-3">
                    <small class="fw-bold">GOAL:</small> Top 3 vehicles by distance yesterday<br>
                    <code class="text-success">API: Get all trips → aggregate by device → sort</code><br>
                    <div class="mt-1 p-2 bg-warning-subtle border border-warning rounded">
                        <small class="fw-bold text-warning">Ace question:</small><br>
                        <code class="text-dark" style="font-size:11px;" id="t3-ace-question">"What are the top 3 vehicles by total distance traveled on [YYYY-MM-DD]? Return columns: device_name, miles. Use UTC timezone."</code>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="bg-success-subtle border border-success rounded p-3">
                            <small class="fw-bold text-success">API (Trips-First)</small>
                            <div class="fs-4 fw-bold text-success" id="t3-api-status">Waiting...</div>
                            <small class="text-muted" id="t3-api-time">--</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-warning-subtle border border-warning rounded p-3" id="t3-ace-box">
                            <small class="fw-bold text-warning">ACE (Natural Language)</small>
                            <div class="fs-4 fw-bold text-warning" id="t3-ace-status">Queued...</div>
                            <small class="text-muted" id="t3-ace-time">--</small>
                        </div>
                    </div>
                </div>
                <pre class="bg-success-subtle border border-success p-2 rounded mt-2 overflow-auto" style="max-height:150px;font-size:10px;" id="t3-api-result"></pre>
                <pre class="bg-warning-subtle border border-warning p-2 rounded mt-2 overflow-auto" style="max-height:300px;font-size:9px;" id="t3-ace-result"></pre>
                <pre class="bg-secondary-subtle p-2 rounded mt-2 overflow-auto" style="max-height:250px;font-size:9px;" id="t3-debug"></pre>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card mb-3">
            <div class="card-header"><h5 class="mb-0">Activity Log</h5></div>
            <div class="card-body">
                <div class="bg-light p-2 rounded overflow-auto" style="max-height:200px;font-size:10px;font-family:monospace;" id="log"></div>
            </div>
        </div>

        <!-- Key Takeaways -->
        <div class="card bg-primary-subtle border-primary">
            <div class="card-header bg-primary text-white"><h5 class="mb-0">Key Takeaways</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong class="text-success">Direct API</strong>
                        <ul class="small mb-0">
                            <li>~300-500ms response</li>
                            <li>Real-time data</li>
                            <li>Raw data (you aggregate)</li>
                            <li>5000 result limit per call</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong class="text-warning">Ace AI</strong>
                        <ul class="small mb-0">
                            <li>~30-90 sec response</li>
                            <li>Queries BigQuery warehouse</li>
                            <li>Natural language queries</li>
                            <li>Filters: IsTracked=TRUE</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong class="text-primary">When to Use</strong>
                        <ul class="small mb-0">
                            <li>API: live data, writes, speed</li>
                            <li>Ace: trends, insights, NL queries</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        var ACE_STAGGER_DELAY = 8000;
        var ACE_CREATE_CHAT_RETRIES = 3;
        var ACE_RETRY_DELAY = 3000;
        var ACE_INITIAL_POLL_DELAY = 8000;
        var ACE_POLL_INTERVAL = 5000;
        var ACE_MAX_POLL_ATTEMPTS = 30;
        var deviceCache = {};
        var test2ApiTimestamp = null;

        console.log('Ace vs API Comparison v3.6 initializing');

        // ============================================
        // LOGGING UTILITIES
        // ============================================
        function log(m) {
            var d = document.getElementById('log');
            var t = new Date().toLocaleTimeString();
            d.innerHTML = '<div>[' + t + '] ' + m + '</div>' + d.innerHTML;
        }

        function debug(id, m) {
            var d = document.getElementById(id);
            if (d) d.textContent += m + '\n';
        }

        function result(id, m) {
            var d = document.getElementById(id);
            if (d) d.textContent += m + '\n';
        }

        function getAceData(r) {
            if (r && r.apiResult && r.apiResult.results) {
                return r.apiResult.results[0] || {};
            }
            return r || {};
        }

        // Parse Ace preview_array which may contain JSON strings in f0_ column
        function parseAcePreviewArray(arr) {
            if (!arr || arr.length === 0) return arr;
            return arr.map(function(row) {
                if (row.f0_ && typeof row.f0_ === 'string') {
                    try {
                        return JSON.parse(row.f0_);
                    } catch(e) {
                        return row;
                    }
                }
                return row;
            });
        }

        // ============================================
        // GEOTAB ADD-IN REGISTRATION
        // ============================================
        geotab.addin['ace-api-comparison'] = function() {
            return {
                initialize: function(api, state, callback) {
                    log('Add-in v3.6 initialized (with customerData: true)');

                    api.call('Get', { typeName: 'Device' }, function(devices) {
                        devices.forEach(function(d) { deviceCache[d.id] = d.name || d.id; });
                        log('Cached ' + devices.length + ' devices' + (devices.length >= 5000 ? ' (LIMIT)' : ''));

                        runTest1Api(api);
                        runTest2Api(api);
                        runTest3Api(api);

                        setTimeout(function() {
                            document.getElementById('t1-ace-status').textContent = 'Processing...';
                            runTest1Ace(api);
                        }, 100);

                        setTimeout(function() {
                            document.getElementById('t2-ace-result').textContent = 'Processing...';
                            runTest2Ace(api);
                        }, ACE_STAGGER_DELAY);

                        setTimeout(function() {
                            document.getElementById('t3-ace-status').textContent = 'Processing...';
                            runTest3Ace(api);
                        }, ACE_STAGGER_DELAY * 2);

                    }, function(e) {
                        log('ERROR: Failed to load devices');
                    });

                    callback();
                },
                focus: function() {},
                blur: function() {}
            };
        };

        // ============================================
        // TEST 1: SPEED COMPARISON
        // ============================================
        function runTest1Api(api) {
            var start = Date.now();
            document.getElementById('t1-api-status').textContent = 'Fetching...';

            api.call('GetCountOf', { typeName: 'Device' }, function(count) {
                var elapsed = Date.now() - start;
                document.getElementById('t1-api-status').textContent = count + ' devices';
                document.getElementById('t1-api-time').textContent = elapsed + 'ms';
                debug('t1-debug', 'API (GetCountOf): ' + count + ' devices in ' + elapsed + 'ms');
                debug('t1-debug', 'Note: GetCountOf includes inactive devices');
            }, function(e) {
                document.getElementById('t1-api-status').textContent = 'Error';
                debug('t1-debug', 'ERROR: ' + e);
            });
        }

        function runTest1Ace(api) {
            var question = 'How many vehicles are in my fleet? Return a single column named vehicle_count.';
            var start = Date.now();

            debug('t1-debug', '=== ACE QUESTION SENT ===');
            debug('t1-debug', question);
            debug('t1-debug', '');

            aceQuery(api, question, 't1', function(res) {
                var elapsed = Date.now() - start;

                debug('t1-debug', '=== ACE IDs (for debugging) ===');
                debug('t1-debug', 'chat_id: ' + res.chatId);
                debug('t1-debug', 'message_group_id: ' + res.messageGroupId);
                debug('t1-debug', '');
                debug('t1-debug', '=== ACE RESPONSE ===');
                debug('t1-debug', 'preview_array (raw): ' + JSON.stringify(res.previewArray));

                var parsed = parseAcePreviewArray(res.previewArray);
                debug('t1-debug', 'preview_array (parsed): ' + JSON.stringify(parsed));
                debug('t1-debug', 'columns: ' + JSON.stringify(res.columns));
                if (res.query) debug('t1-debug', 'SQL: ' + res.query);
                if (res.signedUrls && res.signedUrls.length > 0) {
                    debug('t1-debug', '');
                    debug('t1-debug', '=== CSV URL (copy to fetch manually) ===');
                    debug('t1-debug', res.signedUrls[0]);
                }
                if (res.reasoning) {
                    debug('t1-debug', '');
                    debug('t1-debug', '=== REASONING ===');
                    debug('t1-debug', res.reasoning.substring(0, 300));
                }

                var count = '--';
                if (parsed && parsed.length > 0) {
                    var row = parsed[0];
                    // We asked for 'vehicle_count' column
                    count = row.vehicle_count || row[Object.keys(row)[0]] || '--';
                }
                document.getElementById('t1-ace-status').textContent = count + ' vehicles';
                document.getElementById('t1-ace-time').textContent = Math.round(elapsed / 1000) + 's';
                log('Test1 Ace: ' + count);
            }, function(e) {
                document.getElementById('t1-ace-status').textContent = 'Error';
                debug('t1-debug', 'ERROR: ' + e);
            });
        }

        // ============================================
        // TEST 2: FRESHNESS COMPARISON
        // ============================================
        // Format timestamp in UTC for consistent comparison
        function formatTimestampUTC(date) {
            var y = date.getUTCFullYear();
            var m = String(date.getUTCMonth() + 1).padStart(2, '0');
            var d = String(date.getUTCDate()).padStart(2, '0');
            var h = String(date.getUTCHours()).padStart(2, '0');
            var min = String(date.getUTCMinutes()).padStart(2, '0');
            return y + '-' + m + '-' + d + ' ' + h + ':' + min + ' UTC';
        }

        function runTest2Api(api) {
            document.getElementById('t2-api-result').textContent = 'Fetching...';
            var now = new Date();
            var fromDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            debug('t2-debug', 'API: Trips from last 24 hours (real-time)');
            debug('t2-debug', 'From: ' + fromDate.toISOString());
            debug('t2-debug', 'To: ' + now.toISOString());

            api.call('Get', {
                typeName: 'Trip',
                search: { fromDate: fromDate.toISOString(), toDate: now.toISOString() }
            }, function(trips) {
                debug('t2-debug', 'API: ' + trips.length + ' trips in 24h' + (trips.length >= 5000 ? ' (LIMIT)' : ''));

                if (trips && trips.length > 0) {
                    trips.sort(function(a, b) { return new Date(b.stop) - new Date(a.stop); });
                    var t = trips[0];
                    var stopTime = new Date(t.stop);
                    test2ApiTimestamp = stopTime;
                    var deviceName = deviceCache[t.device.id] || t.device.id;

                    document.getElementById('t2-api-result').innerHTML =
                        '<small>' + deviceName + '</small><br><span class="text-success fw-bold">' + formatTimestampUTC(stopTime) + '</span>';
                } else {
                    document.getElementById('t2-api-result').textContent = 'No trips';
                }
            }, function(e) {
                document.getElementById('t2-api-result').textContent = 'Error';
            });
        }

        function runTest2Ace(api) {
            var question = 'What is the most recent trip in my fleet? Return columns: device_name, trip_end_time. Use UTC timezone.';

            debug('t2-debug', '=== ACE QUESTION SENT ===');
            debug('t2-debug', question);
            debug('t2-debug', '');

            aceQuery(api, question, 't2', function(res) {
                debug('t2-debug', '=== ACE IDs (for debugging) ===');
                debug('t2-debug', 'chat_id: ' + res.chatId);
                debug('t2-debug', 'message_group_id: ' + res.messageGroupId);
                debug('t2-debug', '');
                debug('t2-debug', '=== ACE RESPONSE ===');
                debug('t2-debug', 'preview_array (raw): ' + JSON.stringify(res.previewArray));

                var parsed = parseAcePreviewArray(res.previewArray);
                debug('t2-debug', 'preview_array (parsed): ' + JSON.stringify(parsed));
                debug('t2-debug', 'columns: ' + JSON.stringify(res.columns));
                if (res.query) debug('t2-debug', 'SQL: ' + res.query);
                if (res.signedUrls && res.signedUrls.length > 0) {
                    debug('t2-debug', '');
                    debug('t2-debug', '=== CSV URL (copy to fetch manually) ===');
                    debug('t2-debug', res.signedUrls[0]);
                }
                if (res.reasoning) {
                    debug('t2-debug', '');
                    debug('t2-debug', '=== REASONING ===');
                    debug('t2-debug', res.reasoning.substring(0, 300));
                }

                if (parsed && parsed.length > 0 && res.columns && res.columns.length >= 2) {
                    var d = parsed[0];
                    var cols = res.columns;
                    // Use column position instead of name - col[0]=device, col[1]=time
                    var name = d[cols[0]] || 'Unknown';
                    var timeStr = d[cols[1]] || 'Unknown';

                    // Check if we got UTC time (column name contains UTC)
                    var tzNote = cols[1].includes('UTC') ? '' : ' (device local)';
                    document.getElementById('t2-ace-result').innerHTML =
                        '<small>' + name + '</small><br><span class="text-warning fw-bold">' + timeStr + tzNote + '</span>';

                    // Calculate actual lag between API and Ace timestamps
                    var compBox = document.getElementById('t2-comparison');
                    compBox.classList.remove('d-none');

                    // Try to parse Ace timestamp and compare with API
                    var aceTime = null;
                    try {
                        // Handle formats like "2026-02-04 07:22:29.191 UTC"
                        var cleanTime = timeStr.replace(' UTC', 'Z').replace(' ', 'T');
                        aceTime = new Date(cleanTime);
                    } catch (e) { }

                    if (aceTime && test2ApiTimestamp && !isNaN(aceTime.getTime())) {
                        var lagMs = test2ApiTimestamp.getTime() - aceTime.getTime();
                        var lagMin = Math.round(Math.abs(lagMs) / 60000);
                        var lagStr = lagMin < 60 ? lagMin + ' minutes' : Math.round(lagMin / 60 * 10) / 10 + ' hours';

                        if (lagMs > 0) {
                            compBox.innerHTML = '<strong class="text-info">Measured lag: API is ' + lagStr + ' ahead of Ace</strong>';
                        } else {
                            compBox.innerHTML = '<strong class="text-info">Note: Different devices returned. Ace timestamp is newer (different trip).</strong>';
                        }
                    } else {
                        compBox.innerHTML = '<strong class="text-info">Note: Could not compare timestamps (different formats or devices)</strong>';
                    }
                } else {
                    document.getElementById('t2-ace-result').innerHTML = '<small>No table data (see debug)</small>';
                }
            }, function(e) {
                document.getElementById('t2-ace-result').textContent = 'Error';
                debug('t2-debug', 'ERROR: ' + e);
            });
        }

        // ============================================
        // TEST 3: COMPLEX ANALYSIS
        // ============================================
        function runTest3Api(api) {
            var now = new Date();
            var todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            var yesterdayStart = new Date(todayUTC.getTime() - 24 * 60 * 60 * 1000);
            var yesterdayEnd = new Date(todayUTC.getTime() - 1);
            var yesterdayStr = yesterdayStart.toISOString().split('T')[0];

            debug('t3-debug', 'API: Get all trips from yesterday UTC (' + yesterdayStr + '), then aggregate');
            var start = Date.now();
            document.getElementById('t3-api-status').textContent = 'Loading trips...';

            // Better approach: Get ALL trips first, then aggregate by device
            api.call('Get', {
                typeName: 'Trip',
                search: {
                    fromDate: yesterdayStart.toISOString(),
                    toDate: yesterdayEnd.toISOString()
                },
                resultsLimit: 50000
            }, function(trips) {
                debug('t3-debug', 'Found ' + trips.length + ' trips' + (trips.length >= 50000 ? ' (LIMIT)' : ''));
                document.getElementById('t3-api-status').textContent = 'Aggregating...';

                // Aggregate by device ID
                var byDevice = {};
                trips.forEach(function(t) {
                    var id = t.device.id;
                    if (!byDevice[id]) byDevice[id] = { km: 0, trips: 0 };
                    byDevice[id].km += t.distance || 0;
                    byDevice[id].trips++;
                });

                // Sort and get top 3 device IDs
                var sorted = Object.keys(byDevice)
                    .map(function(id) {
                        return {
                            id: id,
                            km: byDevice[id].km,
                            miles: byDevice[id].km * 0.621371,
                            trips: byDevice[id].trips,
                            name: deviceCache[id] || id  // Use cached name
                        };
                    })
                    .sort(function(a, b) { return b.miles - a.miles; });

                var top3 = sorted.slice(0, 3);
                var totalMiles = sorted.reduce(function(sum, d) { return sum + d.miles; }, 0);
                var elapsed = Date.now() - start;

                result('t3-api-result', '=== API Results (trips-first) ===');
                result('t3-api-result', Object.keys(byDevice).length + ' devices with trips, ' + trips.length + ' total trips');
                result('t3-api-result', 'Total: ' + totalMiles.toFixed(1) + ' miles');
                top3.forEach(function(d, i) {
                    result('t3-api-result', (i + 1) + '. ' + d.name + ': ' + d.miles.toFixed(1) + ' mi (' + d.trips + ' trips)');
                });

                // Show top 3 in status box
                var statusHtml = top3.map(function(d, i) {
                    return (i + 1) + '. ' + d.name + ': ' + d.miles.toFixed(1) + ' mi';
                }).join('<br>');
                document.getElementById('t3-api-status').innerHTML = '<small>' + statusHtml + '</small>';
                document.getElementById('t3-api-time').textContent = elapsed + 'ms';
            }, function(e) {
                document.getElementById('t3-api-status').textContent = 'Error';
                debug('t3-debug', 'ERROR: ' + e);
            });
        }

        function runTest3Ace(api) {
            var now = new Date();
            var todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            var yesterdayStart = new Date(todayUTC.getTime() - 24 * 60 * 60 * 1000);
            var yesterdayStr = yesterdayStart.toISOString().split('T')[0];
            var question = 'What are the top 3 vehicles by total distance traveled on ' + yesterdayStr + '? Return columns: device_name, miles. Use UTC timezone.';

            // Update the displayed question with actual date
            var qEl = document.getElementById('t3-ace-question');
            if (qEl) qEl.textContent = '"' + question + '"';

            debug('t3-debug', '=== ACE QUESTION SENT ===');
            debug('t3-debug', question);
            debug('t3-debug', '');

            var start = Date.now();

            aceQuery(api, question, 't3', function(res) {
                var elapsed = Date.now() - start;

                debug('t3-debug', '=== ACE IDs (for debugging) ===');
                debug('t3-debug', 'chat_id: ' + res.chatId);
                debug('t3-debug', 'message_group_id: ' + res.messageGroupId);
                debug('t3-debug', '');
                debug('t3-debug', '=== ACE RESPONSE ===');
                debug('t3-debug', 'preview_array (raw): ' + JSON.stringify(res.previewArray));

                var parsed = parseAcePreviewArray(res.previewArray);
                debug('t3-debug', 'preview_array (parsed): ' + JSON.stringify(parsed));
                debug('t3-debug', 'columns: ' + JSON.stringify(res.columns));

                if (res.query) {
                    debug('t3-debug', '');
                    debug('t3-debug', '=== SQL QUERY ===');
                    debug('t3-debug', res.query);
                }
                if (res.signedUrls && res.signedUrls.length > 0) {
                    debug('t3-debug', '');
                    debug('t3-debug', '=== CSV URL (copy to fetch manually - CORS blocks browser fetch) ===');
                    debug('t3-debug', res.signedUrls[0]);
                }
                if (res.reasoning) {
                    debug('t3-debug', '');
                    debug('t3-debug', '=== REASONING ===');
                    debug('t3-debug', res.reasoning);
                }

                result('t3-ace-result', '=== Ace Results ===');
                result('t3-ace-result', 'chat_id: ' + res.chatId);
                result('t3-ace-result', 'message_group_id: ' + res.messageGroupId);
                result('t3-ace-result', '');

                if (parsed && parsed.length > 0 && res.columns && res.columns.length >= 2) {
                    var aceTop3 = [];
                    var cols = res.columns;
                    // Use column position instead of name - col[0]=device, col[1]=miles
                    parsed.forEach(function(row, i) {
                        var name = row[cols[0]] || 'Unknown';
                        var dist = row[cols[1]] || '?';
                        result('t3-ace-result', (i + 1) + '. ' + name + ': ' + dist + ' mi');
                        aceTop3.push({ name: name, miles: dist });
                    });
                    // Show top 3 in status box
                    var statusHtml = aceTop3.map(function(d, i) {
                        return (i + 1) + '. ' + d.name + ': ' + d.miles + ' mi';
                    }).join('<br>');
                    document.getElementById('t3-ace-status').innerHTML = '<small>' + statusHtml + '</small>';
                } else {
                    result('t3-ace-result', 'preview_array is empty: ' + JSON.stringify(res.previewArray));
                    result('t3-ace-result', 'columns expected: ' + JSON.stringify(res.columns));
                    if (res.query) result('t3-ace-result', '');
                    if (res.query) result('t3-ace-result', 'SQL ran (check IsTracked filter):');
                    if (res.query) result('t3-ace-result', res.query);
                    document.getElementById('t3-ace-status').textContent = 'No data';
                }

                document.getElementById('t3-ace-time').textContent = Math.round(elapsed / 1000) + 's';
            }, function(e) {
                document.getElementById('t3-ace-status').textContent = 'Error';
                debug('t3-debug', 'ERROR: ' + e);
            });
        }

        // ============================================
        // ACE QUERY HELPER
        // ============================================
        function aceQuery(api, question, testId, onSuccess, onError) {
            log('Ace [' + testId + ']: sending query...');
            var savedChatId = null;
            var savedMgId = null;

            function tryCreateChat(attempt) {
                api.call('GetAceResults', {
                    serviceName: 'dna-planet-orchestration',
                    functionName: 'create-chat',
                    customerData: true,
                    functionParameters: {}
                }, function(r) {
                    var d = getAceData(r);
                    var chatId = d.chat_id;
                    if (!chatId) {
                        if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {
                            setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);
                        } else {
                            onError('No chat_id');
                        }
                        return;
                    }
                    savedChatId = chatId;
                    onChatCreated(chatId);
                }, function(e) {
                    if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {
                        setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);
                    } else {
                        onError('create-chat failed');
                    }
                });
            }

            function onChatCreated(chatId) {
                api.call('GetAceResults', {
                    serviceName: 'dna-planet-orchestration',
                    functionName: 'send-prompt',
                    customerData: true,
                    functionParameters: { chat_id: chatId, prompt: question }
                }, function(r2) {
                    var d2 = getAceData(r2);
                    var mgId = d2.message_group_id || ((d2.message_group || {}).id);
                    if (!mgId) { onError('No message_group_id'); return; }
                    savedMgId = mgId;

                    setTimeout(function() {
                        pollAce(api, chatId, mgId, testId, onSuccess, onError, 0);
                    }, ACE_INITIAL_POLL_DELAY);
                }, function(e) {
                    onError('send-prompt failed');
                });
            }

            function pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt) {
                if (attempt >= ACE_MAX_POLL_ATTEMPTS) { onError('Timeout'); return; }

                api.call('GetAceResults', {
                    serviceName: 'dna-planet-orchestration',
                    functionName: 'get-message-group',
                    customerData: true,
                    functionParameters: { chat_id: chatId, message_group_id: mgId }
                }, function(r) {
                    var d = getAceData(r);
                    var mg = d.message_group || {};
                    var st = mg.status ? mg.status.status : 'UNKNOWN';

                    if (st === 'DONE') {
                        var msgs = mg.messages || {};
                        var res = {
                            chatId: savedChatId,
                            messageGroupId: savedMgId,
                            previewArray: null,
                            reasoning: null,
                            query: null,
                            columns: null,
                            signedUrls: null
                        };

                        Object.keys(msgs).forEach(function(k) {
                            var m = msgs[k];
                            if (m.preview_array !== undefined) res.previewArray = m.preview_array;
                            if (m.reasoning) res.reasoning = m.reasoning;
                            if (m.query) res.query = m.query;
                            if (m.columns) res.columns = m.columns;
                            if (m.signed_urls) res.signedUrls = m.signed_urls;
                        });

                        onSuccess(res);
                    } else if (st === 'FAILED') {
                        onError('FAILED: ' + (mg.status.message || 'Unknown'));
                    } else {
                        setTimeout(function() {
                            pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);
                        }, ACE_POLL_INTERVAL);
                    }
                }, function(e) {
                    setTimeout(function() {
                        pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);
                    }, ACE_POLL_INTERVAL);
                });
            }

            tryCreateChat(0);
        }

        console.log('Ace vs API Comparison v3.6 loaded');
    </script>
</body>
</html>
