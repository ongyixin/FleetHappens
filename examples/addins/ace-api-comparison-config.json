{
  "name": "Ace vs API Comparison",
  "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide",
  "version": "2.6",
  "items": [
    {
      "url": "page.html",
      "path": "ActivityLink",
      "menuName": {
        "en": "Ace vs API Comparison"
      }
    }
  ],
  "files": {
    "page.html": "<!DOCTYPE html>\n<html>\n<head>\n    <meta charset='utf-8'>\n    <meta name='viewport' content='width=device-width, initial-scale=1'>\n    <title>Ace vs API Comparison v2.7</title>\n</head>\n<body class='bg-light p-4'>\n    <div class='container'>\n        <h1 class='mb-1'>Ace vs Direct API Comparison v2.7</h1>\n        <p class='text-muted mb-4'>Three tests demonstrating when to use each approach</p>\n        \n        <div class='alert alert-warning mb-4' role='alert' style='color:#78350f;'>\n            <strong>Note:</strong> Ace queries start 8s apart to avoid rate limits. API has a 5000 result limit per call.\n        </div>\n\n        <!-- Test 1: Speed -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>1️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Speed Test</h5>\n                    <small class='text-muted'>Same question, timing comparison</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: api.call('Get', {typeName: 'Device'}), count results</code><br>\n                    <em style='color:#92400e;'>Ace: \"How many vehicles are in my fleet?\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>DIRECT API</small>\n                            <div class='fs-3 fw-bold text-success' id='t1-api-status'>Waiting...</div>\n                            <small class='text-muted' id='t1-api-time'>--</small>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t1-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Natural Language)</small>\n                            <div class='fs-3 fw-bold' style='color:#b45309;' id='t1-ace-status'>Queued...</div>\n                            <small class='text-muted' id='t1-ace-time'>--</small>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 small overflow-auto' style='max-height:300px;font-size:9px;word-wrap:break-word;white-space:pre-wrap;' id='t1-debug'></pre>\n            </div>\n        </div>\n\n        <!-- Test 2: Freshness -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>2️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Freshness Test</h5>\n                    <small class='text-muted'>Ace data can be hours behind real-time</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: Get Trip (yesterday UTC), find latest stop time</code><br>\n                    <em style='color:#92400e;'>Ace: \"Most recent trip yesterday [date]?\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>API (Real-time)</small>\n                            <div id='t2-api-result' class='fw-bold' style='font-size:14px;'>Waiting...</div>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t2-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Natural Language)</small>\n                            <div id='t2-ace-result' class='fw-bold' style='font-size:14px;color:#b45309;'>Queued...</div>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 small overflow-auto' style='max-height:300px;font-size:9px;word-wrap:break-word;white-space:pre-wrap;' id='t2-debug'></pre>\n                <div id='t2-comparison' class='mt-2 p-2 rounded text-center d-none' style='background:#fef3c7;border:2px dashed #f59e0b;'></div>\n            </div>\n        </div>\n\n        <!-- Test 3: Complex Analysis -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>3️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Complex Analysis</h5>\n                    <small class='text-muted'>Per-device trip queries vs Ace aggregate</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: For each device, Get Trip with deviceSearch:{id:xxx}, sum distances</code><br>\n                    <em style='color:#92400e;'>Ace: \"Top 3 vehicles by distance (30 days), show device_name and miles.\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>API (Per-Device Queries)</small>\n                            <div class='fs-4 fw-bold text-success' id='t3-api-status'>Waiting...</div>\n                            <small class='text-muted' id='t3-api-time'>--</small>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t3-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Natural Language)</small>\n                            <div class='fs-4 fw-bold' style='color:#b45309;' id='t3-ace-status'>Queued...</div>\n                            <small class='text-muted' id='t3-ace-time'>--</small>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-success-subtle border border-success p-2 rounded mt-2 overflow-auto' style='max-height:150px;font-size:10px;' id='t3-api-result'></pre>\n                <pre class='bg-warning-subtle border border-warning p-2 rounded mt-2 overflow-auto' style='max-height:300px;font-size:9px;color:#78350f;word-wrap:break-word;white-space:pre-wrap;' id='t3-ace-result'></pre>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 overflow-auto' style='max-height:250px;font-size:9px;word-wrap:break-word;white-space:pre-wrap;' id='t3-debug'></pre>\n            </div>\n        </div>\n\n        <!-- Activity Log -->\n        <div class='card mb-3'>\n            <div class='card-header'><h5 class='mb-0'>Activity Log</h5></div>\n            <div class='card-body'>\n                <div class='bg-light p-2 rounded overflow-auto' style='max-height:200px;font-size:10px;font-family:monospace;' id='log'></div>\n            </div>\n        </div>\n\n        <!-- Key Takeaways -->\n        <div class='card bg-primary-subtle border-primary'>\n            <div class='card-header bg-primary text-white'><h5 class='mb-0'>Key Takeaways</h5></div>\n            <div class='card-body'>\n                <div class='row'>\n                    <div class='col-md-4'>\n                        <strong class='text-success'>Direct API</strong>\n                        <ul class='small mb-0'>\n                            <li>~300-500ms response</li>\n                            <li>Real-time data</li>\n                            <li>Raw data (you aggregate)</li>\n                            <li>5000 result limit per call</li>\n                        </ul>\n                    </div>\n                    <div class='col-md-4'>\n                        <strong style='color:#b45309;'>Ace AI</strong>\n                        <ul class='small mb-0'>\n                            <li>~30-90 sec response</li>\n                            <li>Queries BigQuery warehouse</li>\n                            <li>Natural language queries</li>\n                            <li>Filters: IsTracked=TRUE</li>\n                        </ul>\n                    </div>\n                    <div class='col-md-4'>\n                        <strong class='text-primary'>When to Use</strong>\n                        <ul class='small mb-0'>\n                            <li>API: live data, writes, speed</li>\n                            <li>Ace: trends, insights, NL queries</li>\n                        </ul>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // ============================================\n        // LOAD BOOTSTRAP CSS DYNAMICALLY\n        // ============================================\n        (function() {\n            var link = document.createElement('link');\n            link.rel = 'stylesheet';\n            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css';\n            document.head.appendChild(link);\n        })();\n\n        // ============================================\n        // CONFIGURATION\n        // ============================================\n        var ACE_STAGGER_DELAY = 8000;\n        var ACE_CREATE_CHAT_RETRIES = 3;\n        var ACE_RETRY_DELAY = 3000;\n        var ACE_INITIAL_POLL_DELAY = 8000;\n        var ACE_POLL_INTERVAL = 5000;\n        var ACE_MAX_POLL_ATTEMPTS = 30;\n        var deviceCache = {};\n        var test2ApiTimestamp = null;\n\n        console.log('Ace vs API Comparison v2.7 initializing');\n\n        // ============================================\n        // LOGGING UTILITIES\n        // ============================================\n        function log(m) {\n            var d = document.getElementById('log');\n            var t = new Date().toLocaleTimeString();\n            d.innerHTML = '<div>[' + t + '] ' + m + '</div>' + d.innerHTML;\n        }\n\n        function debug(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n        }\n\n        function result(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n        }\n\n        function getAceData(r) {\n            if (r && r.apiResult && r.apiResult.results) {\n                return r.apiResult.results[0] || {};\n            }\n            return r || {};\n        }\n\n        // Parse Ace preview_array which may contain JSON strings in f0_ column\n        function parseAcePreviewArray(arr) {\n            if (!arr || arr.length === 0) return arr;\n            return arr.map(function(row) {\n                // Check if row has f0_ column with JSON string\n                if (row.f0_ && typeof row.f0_ === 'string') {\n                    try {\n                        return JSON.parse(row.f0_);\n                    } catch(e) {\n                        return row;\n                    }\n                }\n                return row;\n            });\n        }\n\n        // ============================================\n        // GEOTAB ADD-IN REGISTRATION\n        // ============================================\n        geotab.addin['ace-api-comparison'] = function() {\n            return {\n                initialize: function(api, state, callback) {\n                    log('Add-in v2.7 initialized (with customerData: true)');\n                    \n                    api.call('Get', { typeName: 'Device' }, function(devices) {\n                        devices.forEach(function(d) { deviceCache[d.id] = d.name || d.id; });\n                        log('Cached ' + devices.length + ' devices' + (devices.length >= 5000 ? ' (LIMIT)' : ''));\n                        \n                        runTest1Api(api);\n                        runTest2Api(api);\n                        runTest3Api(api);\n                        \n                        setTimeout(function() {\n                            document.getElementById('t1-ace-status').textContent = 'Processing...';\n                            runTest1Ace(api);\n                        }, 100);\n                        \n                        setTimeout(function() {\n                            document.getElementById('t2-ace-result').textContent = 'Processing...';\n                            runTest2Ace(api);\n                        }, ACE_STAGGER_DELAY);\n                        \n                        setTimeout(function() {\n                            document.getElementById('t3-ace-status').textContent = 'Processing...';\n                            runTest3Ace(api);\n                        }, ACE_STAGGER_DELAY * 2);\n                        \n                    }, function(e) {\n                        log('ERROR: Failed to load devices');\n                    });\n                    \n                    callback();\n                },\n                focus: function() {},\n                blur: function() {}\n            };\n        };\n\n        // ============================================\n        // TEST 1: SPEED COMPARISON\n        // ============================================\n        function runTest1Api(api) {\n            var start = Date.now();\n            document.getElementById('t1-api-status').textContent = 'Fetching...';\n\n            api.call('Get', { typeName: 'Device' }, function(devices) {\n                var elapsed = Date.now() - start;\n                document.getElementById('t1-api-status').textContent = devices.length + ' devices' + (devices.length >= 5000 ? ' (limit)' : '');\n                document.getElementById('t1-api-time').textContent = elapsed + 'ms';\n                debug('t1-debug', 'API: ' + devices.length + ' devices in ' + elapsed + 'ms');\n            }, function(e) {\n                document.getElementById('t1-api-status').textContent = 'Error';\n            });\n        }\n\n        function runTest1Ace(api) {\n            var question = 'How many vehicles are in my fleet?';\n            var start = Date.now();\n            \n            aceQuery(api, question, 't1', function(res) {\n                var elapsed = Date.now() - start;\n                \n                debug('t1-debug', '=== ACE IDs (for debugging) ===');\n                debug('t1-debug', 'chat_id: ' + res.chatId);\n                debug('t1-debug', 'message_group_id: ' + res.messageGroupId);\n                debug('t1-debug', '');\n                debug('t1-debug', '=== ACE RESPONSE ===');\n                debug('t1-debug', 'preview_array (raw): ' + JSON.stringify(res.previewArray));\n                \n                var parsed = parseAcePreviewArray(res.previewArray);\n                debug('t1-debug', 'preview_array (parsed): ' + JSON.stringify(parsed));\n                debug('t1-debug', 'columns: ' + JSON.stringify(res.columns));\n                if (res.query) debug('t1-debug', 'SQL: ' + res.query);\n                if (res.signedUrls && res.signedUrls.length > 0) {\n                    debug('t1-debug', '');\n                    debug('t1-debug', '=== CSV URL (copy to fetch manually) ===');\n                    debug('t1-debug', res.signedUrls[0]);\n                }\n                if (res.reasoning) {\n                    debug('t1-debug', '');\n                    debug('t1-debug', '=== REASONING ===');\n                    debug('t1-debug', res.reasoning.substring(0, 300));\n                }\n\n                var count = '--';\n                if (parsed && parsed.length > 0) {\n                    var row = parsed[0];\n                    count = row.count || row.Count || row.vehicle_count || row.VehicleCount ||\n                            row.NumberOfActiveVehicles || row.NumberOfVehicles || row.total ||\n                            row[Object.keys(row)[0]] || '--';\n                }\n                document.getElementById('t1-ace-status').textContent = count + ' vehicles';\n                document.getElementById('t1-ace-time').textContent = Math.round(elapsed / 1000) + 's';\n                log('Test1 Ace: ' + count);\n            }, function(e) {\n                document.getElementById('t1-ace-status').textContent = 'Error';\n                debug('t1-debug', 'ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // TEST 2: FRESHNESS COMPARISON\n        // ============================================\n        function formatTimestamp(date) {\n            var y = date.getFullYear();\n            var m = String(date.getMonth() + 1).padStart(2, '0');\n            var d = String(date.getDate()).padStart(2, '0');\n            var h = String(date.getHours()).padStart(2, '0');\n            var min = String(date.getMinutes()).padStart(2, '0');\n            return y + '-' + m + '-' + d + ' ' + h + ':' + min;\n        }\n\n        function runTest2Api(api) {\n            document.getElementById('t2-api-result').textContent = 'Fetching...';\n            // Yesterday UTC: midnight to midnight\n            var now = new Date();\n            var todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));\n            var yesterdayStart = new Date(todayUTC.getTime() - 24 * 60 * 60 * 1000);\n            var yesterdayEnd = new Date(todayUTC.getTime() - 1); // 23:59:59.999 yesterday\n            var yesterdayStr = yesterdayStart.toISOString().split('T')[0];\n            \n            debug('t2-debug', 'API: Trips from yesterday UTC (' + yesterdayStr + ')');\n            debug('t2-debug', 'From: ' + yesterdayStart.toISOString());\n            debug('t2-debug', 'To: ' + yesterdayEnd.toISOString());\n\n            api.call('Get', {\n                typeName: 'Trip',\n                search: { fromDate: yesterdayStart.toISOString(), toDate: yesterdayEnd.toISOString() }\n            }, function(trips) {\n                debug('t2-debug', 'API: ' + trips.length + ' trips yesterday' + (trips.length >= 5000 ? ' (LIMIT)' : ''));\n\n                if (trips && trips.length > 0) {\n                    trips.sort(function(a, b) { return new Date(b.stop) - new Date(a.stop); });\n                    var t = trips[0];\n                    var stopTime = new Date(t.stop);\n                    test2ApiTimestamp = stopTime;\n                    var deviceName = deviceCache[t.device.id] || t.device.id;\n                    \n                    document.getElementById('t2-api-result').innerHTML =\n                        '<small>' + deviceName + '</small><br><span class=\"text-success fw-bold\">' + formatTimestamp(stopTime) + '</span>';\n                } else {\n                    document.getElementById('t2-api-result').textContent = 'No trips';\n                }\n            }, function(e) {\n                document.getElementById('t2-api-result').textContent = 'Error';\n            });\n        }\n\n        function runTest2Ace(api) {\n            // Ask for most recent trip yesterday (same date as API query)\n            var now = new Date();\n            var todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));\n            var yesterdayStart = new Date(todayUTC.getTime() - 24 * 60 * 60 * 1000);\n            var yesterdayStr = yesterdayStart.toISOString().split('T')[0];\n            var question = 'What is the most recent trip on ' + yesterdayStr + '? Give me the device name and end time.';\n            \n            aceQuery(api, question, 't2', function(res) {\n                debug('t2-debug', '=== ACE IDs (for debugging) ===');\n                debug('t2-debug', 'chat_id: ' + res.chatId);\n                debug('t2-debug', 'message_group_id: ' + res.messageGroupId);\n                debug('t2-debug', '');\n                debug('t2-debug', '=== ACE RESPONSE ===');\n                debug('t2-debug', 'preview_array (raw): ' + JSON.stringify(res.previewArray));\n                \n                var parsed = parseAcePreviewArray(res.previewArray);\n                debug('t2-debug', 'preview_array (parsed): ' + JSON.stringify(parsed));\n                debug('t2-debug', 'columns: ' + JSON.stringify(res.columns));\n                if (res.query) debug('t2-debug', 'SQL: ' + res.query);\n                if (res.signedUrls && res.signedUrls.length > 0) {\n                    debug('t2-debug', '');\n                    debug('t2-debug', '=== CSV URL (copy to fetch manually) ===');\n                    debug('t2-debug', res.signedUrls[0]);\n                }\n                if (res.reasoning) {\n                    debug('t2-debug', '');\n                    debug('t2-debug', '=== REASONING ===');\n                    debug('t2-debug', res.reasoning.substring(0, 300));\n                }\n\n                if (parsed && parsed.length > 0) {\n                    var d = parsed[0];\n                    var name = d.device_name || d.DeviceName || d.vehicleName || 'Unknown';\n                    var timeStr = d.end_time || d.TripEndDateTime || d.endTime || 'Unknown';\n                    \n                    var utcTimeStr = timeStr;\n                    if (timeStr && typeof timeStr === 'string' && !timeStr.endsWith('Z') && !timeStr.includes('+')) {\n                        utcTimeStr = timeStr.replace(' ', 'T') + 'Z';\n                    }\n                    var aceTime = new Date(utcTimeStr);\n                    var formattedAceTime = isNaN(aceTime.getTime()) ? timeStr : formatTimestamp(aceTime);\n                    \n                    document.getElementById('t2-ace-result').innerHTML =\n                        '<small>' + name + '</small><br><span style=\"color:#b45309;\" class=\"fw-bold\">' + formattedAceTime + '</span>';\n                    \n                    if (test2ApiTimestamp && !isNaN(aceTime.getTime())) {\n                        var diffMs = test2ApiTimestamp.getTime() - aceTime.getTime();\n                        var absDiffMs = Math.abs(diffMs);\n                        var absDiffMins = Math.round(absDiffMs / (1000 * 60));\n                        var diffStr = absDiffMins < 60 ? absDiffMins + ' min' : Math.round(absDiffMins/60) + ' hours';\n                        var compBox = document.getElementById('t2-comparison');\n                        compBox.classList.remove('d-none');\n                        if (absDiffMins < 5) {\n                            compBox.innerHTML = '<strong style=\"color:#059669;\">Timestamps match (within 5 min)</strong>';\n                        } else if (diffMs > 0) {\n                            compBox.innerHTML = '<strong style=\"color:#dc2626;\">Ace is ' + diffStr + ' behind API</strong>';\n                        } else {\n                            compBox.innerHTML = '<strong style=\"color:#dc2626;\">API is ' + diffStr + ' behind Ace (API hit result limit!)</strong>';\n                        }\n                    }\n                } else {\n                    document.getElementById('t2-ace-result').innerHTML = '<small>No table data (see debug)</small>';\n                }\n            }, function(e) {\n                document.getElementById('t2-ace-result').textContent = 'Error';\n                debug('t2-debug', 'ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // TEST 3: COMPLEX ANALYSIS\n        // ============================================\n        function runTest3Api(api) {\n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            \n            debug('t3-debug', 'API: Per-device trips from ' + fromDate.toISOString().split('T')[0]);\n            var start = Date.now();\n            document.getElementById('t3-api-status').textContent = 'Loading...';\n\n            api.call('Get', { typeName: 'Device' }, function(devices) {\n                debug('t3-debug', 'Found ' + devices.length + ' devices' + (devices.length >= 5000 ? ' (LIMIT)' : ''));\n                \n                var deviceDistances = {};\n                var completed = 0;\n                var totalTrips = 0;\n                \n                devices.forEach(function(device) {\n                    api.call('Get', {\n                        typeName: 'Trip',\n                        search: { deviceSearch: { id: device.id }, fromDate: fromDate.toISOString(), toDate: now.toISOString() }\n                    }, function(trips) {\n                        var meters = 0;\n                        trips.forEach(function(trip) { meters += trip.distance || 0; });\n                        \n                        deviceDistances[device.id] = {\n                            name: device.name || device.id,\n                            km: meters / 1000,\n                            miles: (meters / 1000) * 0.621371,\n                            trips: trips.length\n                        };\n                        totalTrips += trips.length;\n                        completed++;\n                        \n                        if (completed % 100 === 0) document.getElementById('t3-api-status').textContent = completed + '/' + devices.length;\n                        if (completed === devices.length) finishTest3Api(deviceDistances, start, totalTrips);\n                    }, function(e) {\n                        completed++;\n                        if (completed === devices.length) finishTest3Api(deviceDistances, start, totalTrips);\n                    });\n                });\n            }, function(e) {\n                document.getElementById('t3-api-status').textContent = 'Error';\n            });\n        }\n        \n        function finishTest3Api(deviceDistances, startTime, totalTrips) {\n            var elapsed = Date.now() - startTime;\n            var sorted = Object.values(deviceDistances).sort(function(a, b) { return b.miles - a.miles; });\n            var top3 = sorted.slice(0, 3);\n            var totalMiles = sorted.reduce(function(sum, d) { return sum + d.miles; }, 0);\n            var devicesWithTrips = sorted.filter(function(d) { return d.trips > 0; }).length;\n            \n            result('t3-api-result', '=== API Results ===');\n            result('t3-api-result', sorted.length + ' devices, ' + devicesWithTrips + ' with trips, ' + totalTrips + ' total trips');\n            result('t3-api-result', 'Total: ' + totalMiles.toFixed(1) + ' miles');\n            top3.forEach(function(d, i) {\n                result('t3-api-result', (i + 1) + '. ' + d.name + ': ' + d.miles.toFixed(1) + ' mi (' + d.trips + ' trips)');\n            });\n            \n            document.getElementById('t3-api-status').textContent = devicesWithTrips + ' devices';\n            document.getElementById('t3-api-time').textContent = elapsed + 'ms';\n        }\n\n        function runTest3Ace(api) {\n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            var fromStr = fromDate.toISOString().split('T')[0];\n            var toStr = now.toISOString().split('T')[0];\n            var question = 'What are the top 3 vehicles by total distance traveled from ' + fromStr + ' to ' + toStr + '? Show device_name and miles.';\n            \n            var start = Date.now();\n\n            aceQuery(api, question, 't3', function(res) {\n                var elapsed = Date.now() - start;\n                \n                debug('t3-debug', '=== ACE IDs (for debugging) ===');\n                debug('t3-debug', 'chat_id: ' + res.chatId);\n                debug('t3-debug', 'message_group_id: ' + res.messageGroupId);\n                debug('t3-debug', '');\n                debug('t3-debug', '=== ACE RESPONSE ===');\n                debug('t3-debug', 'preview_array (raw): ' + JSON.stringify(res.previewArray));\n                \n                var parsed = parseAcePreviewArray(res.previewArray);\n                debug('t3-debug', 'preview_array (parsed): ' + JSON.stringify(parsed));\n                debug('t3-debug', 'columns: ' + JSON.stringify(res.columns));\n                \n                if (res.query) {\n                    debug('t3-debug', '');\n                    debug('t3-debug', '=== SQL QUERY ===');\n                    debug('t3-debug', res.query);\n                }\n                if (res.signedUrls && res.signedUrls.length > 0) {\n                    debug('t3-debug', '');\n                    debug('t3-debug', '=== CSV URL (copy to fetch manually - CORS blocks browser fetch) ===');\n                    debug('t3-debug', res.signedUrls[0]);\n                }\n                if (res.reasoning) {\n                    debug('t3-debug', '');\n                    debug('t3-debug', '=== REASONING ===');\n                    debug('t3-debug', res.reasoning);\n                }\n\n                result('t3-ace-result', '=== Ace Results ===');\n                result('t3-ace-result', 'chat_id: ' + res.chatId);\n                result('t3-ace-result', 'message_group_id: ' + res.messageGroupId);\n                result('t3-ace-result', '');\n\n                if (parsed && parsed.length > 0) {\n                    parsed.forEach(function(row, i) {\n                        var name = row.device_name || row.DeviceName || 'Unknown';\n                        var dist = row.miles || row.Miles || row.TotalDistance_Miles || row.Distance_mi || row.total_miles || '?';\n                        result('t3-ace-result', (i + 1) + '. ' + name + ': ' + dist + ' mi');\n                    });\n                    document.getElementById('t3-ace-status').textContent = parsed.length + ' rows';\n                } else {\n                    result('t3-ace-result', 'preview_array is empty: ' + JSON.stringify(res.previewArray));\n                    result('t3-ace-result', 'columns expected: ' + JSON.stringify(res.columns));\n                    if (res.query) result('t3-ace-result', '');\n                    if (res.query) result('t3-ace-result', 'SQL ran (check IsTracked filter):');\n                    if (res.query) result('t3-ace-result', res.query);\n                    document.getElementById('t3-ace-status').textContent = 'No data';\n                }\n                \n                document.getElementById('t3-ace-time').textContent = Math.round(elapsed / 1000) + 's';\n            }, function(e) {\n                document.getElementById('t3-ace-status').textContent = 'Error';\n                debug('t3-debug', 'ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // ACE QUERY HELPER\n        // ============================================\n        function aceQuery(api, question, testId, onSuccess, onError) {\n            log('Ace [' + testId + ']: sending query...');\n            var savedChatId = null;\n            var savedMgId = null;\n\n            function tryCreateChat(attempt) {\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'create-chat',\n                    customerData: true,\n                    functionParameters: {}\n                }, function(r) {\n                    var d = getAceData(r);\n                    var chatId = d.chat_id;\n                    if (!chatId) {\n                        if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {\n                            setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);\n                        } else {\n                            onError('No chat_id');\n                        }\n                        return;\n                    }\n                    savedChatId = chatId;\n                    onChatCreated(chatId);\n                }, function(e) {\n                    if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {\n                        setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);\n                    } else {\n                        onError('create-chat failed');\n                    }\n                });\n            }\n\n            function onChatCreated(chatId) {\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'send-prompt',\n                    customerData: true,\n                    functionParameters: { chat_id: chatId, prompt: question }\n                }, function(r2) {\n                    var d2 = getAceData(r2);\n                    var mgId = d2.message_group_id || ((d2.message_group || {}).id);\n                    if (!mgId) { onError('No message_group_id'); return; }\n                    savedMgId = mgId;\n                    \n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, 0);\n                    }, ACE_INITIAL_POLL_DELAY);\n                }, function(e) {\n                    onError('send-prompt failed');\n                });\n            }\n\n            function pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt) {\n                if (attempt >= ACE_MAX_POLL_ATTEMPTS) { onError('Timeout'); return; }\n\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'get-message-group',\n                    customerData: true,\n                    functionParameters: { chat_id: chatId, message_group_id: mgId }\n                }, function(r) {\n                    var d = getAceData(r);\n                    var mg = d.message_group || {};\n                    var st = mg.status ? mg.status.status : 'UNKNOWN';\n\n                    if (st === 'DONE') {\n                        var msgs = mg.messages || {};\n                        var res = { \n                            chatId: savedChatId, \n                            messageGroupId: savedMgId,\n                            previewArray: null, \n                            reasoning: null, \n                            query: null, \n                            columns: null, \n                            signedUrls: null \n                        };\n\n                        Object.keys(msgs).forEach(function(k) {\n                            var m = msgs[k];\n                            if (m.preview_array !== undefined) res.previewArray = m.preview_array;\n                            if (m.reasoning) res.reasoning = m.reasoning;\n                            if (m.query) res.query = m.query;\n                            if (m.columns) res.columns = m.columns;\n                            if (m.signed_urls) res.signedUrls = m.signed_urls;\n                        });\n\n                        onSuccess(res);\n                    } else if (st === 'FAILED') {\n                        onError('FAILED: ' + (mg.status.message || 'Unknown'));\n                    } else {\n                        setTimeout(function() {\n                            pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                        }, ACE_POLL_INTERVAL);\n                    }\n                }, function(e) {\n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                    }, ACE_POLL_INTERVAL);\n                });\n            }\n\n            tryCreateChat(0);\n        }\n\n        console.log('Ace vs API Comparison v2.7 loaded');\n    </script>\n</body>\n</html>\n"
  }
}
