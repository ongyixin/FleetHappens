{
  "name": "Ace vs API Comparison",
  "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide",
  "version": "2.1",
  "items": [
    {
      "url": "page.html",
      "path": "ActivityLink",
      "menuName": {
        "en": "Ace vs API Comparison"
      }
    }
  ],
  "files": {
    "page.html": "<!DOCTYPE html>\n<html>\n<head>\n    <meta charset='utf-8'>\n    <meta name='viewport' content='width=device-width, initial-scale=1'>\n    <title>Ace vs API Comparison v2.1</title>\n</head>\n<body class='bg-light p-4'>\n    <div class='container'>\n        <h1 class='mb-1'>Ace vs Direct API Comparison v2.1</h1>\n        <p class='text-muted mb-4'>Three tests demonstrating when to use each approach</p>\n        \n        <div class='alert alert-warning mb-4' role='alert' style='color:#78350f;'>\n            <strong>Note:</strong> Ace queries start 5s apart to avoid rate limits, then poll for results. API calls run immediately.\n        </div>\n\n        <!-- Test 1: Speed -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>1️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Speed Test</h5>\n                    <small class='text-muted'>Same question, timing comparison</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: api.call('Get', {typeName: 'Device'}), count results</code><br>\n                    <em style='color:#92400e;'>Ace: \"How many vehicles are in my fleet?\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>DIRECT API</small>\n                            <div class='fs-3 fw-bold text-success' id='t1-api-status'>Waiting...</div>\n                            <small class='text-muted' id='t1-api-time'>--</small>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t1-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE AI</small>\n                            <div class='fs-3 fw-bold' style='color:#b45309;' id='t1-ace-status'>Queued...</div>\n                            <small class='text-muted' id='t1-ace-time'>--</small>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 small overflow-auto' style='max-height:120px;font-size:10px;' id='t1-debug'></pre>\n            </div>\n        </div>\n\n        <!-- Test 2: Freshness -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>2️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Freshness Test</h5>\n                    <small class='text-muted'>Ace data can be hours behind real-time</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: Get Trip (last 30 days), sort by stop time, get device name</code><br>\n                    <em style='color:#92400e;'>Ace: \"When was the most recent trip in my fleet?\" (unbounded)</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>API (Real-time)</small>\n                            <div id='t2-api-result' class='fw-bold' style='font-size:14px;'>Waiting...</div>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t2-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Historical)</small>\n                            <div id='t2-ace-result' class='fw-bold' style='font-size:14px;color:#b45309;'>Queued...</div>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 small overflow-auto' style='max-height:120px;font-size:10px;' id='t2-debug'></pre>\n                <div id='t2-comparison' class='mt-2 p-2 rounded text-center d-none' style='background:#fef3c7;border:2px dashed #f59e0b;'></div>\n            </div>\n        </div>\n\n        <!-- Test 3: Complex Analysis -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>3️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Complex Analysis</h5>\n                    <small class='text-muted'>API gets raw data (you aggregate), Ace gives analyzed results</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: Get Trip (last 30 days), aggregate distance by device in JavaScript</code><br>\n                    <em style='color:#92400e;'>Ace: \"Top 3 vehicles by distance from [30 days ago] to [today]? Show name and miles.\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>API (Raw + JS Aggregation)</small>\n                            <div class='fs-4 fw-bold text-success' id='t3-api-status'>Waiting...</div>\n                            <small class='text-muted' id='t3-api-time'>--</small>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t3-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Pre-analyzed)</small>\n                            <div class='fs-4 fw-bold' style='color:#b45309;' id='t3-ace-status'>Queued...</div>\n                            <small class='text-muted' id='t3-ace-time'>--</small>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-success-subtle border border-success p-2 rounded mt-2 overflow-auto' style='max-height:150px;font-size:10px;' id='t3-api-result'></pre>\n                <pre class='bg-warning-subtle border border-warning p-2 rounded mt-2 overflow-auto' style='max-height:150px;font-size:10px;color:#78350f;' id='t3-ace-result'></pre>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 overflow-auto' style='max-height:100px;font-size:10px;' id='t3-debug'></pre>\n            </div>\n        </div>\n\n        <!-- Activity Log -->\n        <div class='card mb-3'>\n            <div class='card-header'><h5 class='mb-0'>Activity Log</h5></div>\n            <div class='card-body'>\n                <div class='bg-light p-2 rounded overflow-auto' style='max-height:200px;font-size:10px;font-family:monospace;' id='log'></div>\n            </div>\n        </div>\n\n        <!-- Key Takeaways -->\n        <div class='card bg-primary-subtle border-primary'>\n            <div class='card-header bg-primary text-white'><h5 class='mb-0'>Key Takeaways</h5></div>\n            <div class='card-body'>\n                <div class='row'>\n                    <div class='col-md-4'>\n                        <strong class='text-success'>Direct API</strong>\n                        <ul class='small mb-0'>\n                            <li>~300-500ms response</li>\n                            <li>Real-time data</li>\n                            <li>Raw data only (you process)</li>\n                        </ul>\n                    </div>\n                    <div class='col-md-4'>\n                        <strong style='color:#b45309;'>Ace AI</strong>\n                        <ul class='small mb-0'>\n                            <li>~30-90 sec response</li>\n                            <li>Can be hours behind</li>\n                            <li>Pre-analyzed results</li>\n                        </ul>\n                    </div>\n                    <div class='col-md-4'>\n                        <strong class='text-primary'>When to Use</strong>\n                        <ul class='small mb-0'>\n                            <li>API: live data, writes, speed</li>\n                            <li>Ace: trends, insights, NL queries</li>\n                        </ul>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // ============================================\n        // LOAD BOOTSTRAP CSS DYNAMICALLY\n        // ============================================\n        (function() {\n            var link = document.createElement('link');\n            link.rel = 'stylesheet';\n            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css';\n            document.head.appendChild(link);\n            console.log('[INIT] Bootstrap CSS loaded dynamically');\n        })();\n\n        // ============================================\n        // CONFIGURATION\n        // ============================================\n        var ACE_STAGGER_DELAY = 8000;  // 8 seconds between starting Ace queries (avoid rate limits)\n        var ACE_CREATE_CHAT_RETRIES = 3;  // Retry create-chat up to 3 times\n        var ACE_RETRY_DELAY = 3000;  // Wait 3s between retries\n        var ACE_INITIAL_POLL_DELAY = 8000; // Wait 8s before first poll\n        var ACE_POLL_INTERVAL = 5000;  // Poll every 5s\n        var ACE_MAX_POLL_ATTEMPTS = 30; // Max polling attempts\n        var deviceCache = {};\n        var test2ApiTimestamp = null;  // Store API's most recent trip time for comparison\n\n        console.log('================================================');\n        console.log('Ace vs API Comparison v2.1 initializing');\n        console.log('================================================');\n        console.log('CONFIG: ACE_STAGGER_DELAY =', ACE_STAGGER_DELAY, 'ms');\n        console.log('CONFIG: ACE_INITIAL_POLL_DELAY =', ACE_INITIAL_POLL_DELAY, 'ms');\n        console.log('CONFIG: ACE_POLL_INTERVAL =', ACE_POLL_INTERVAL, 'ms');\n        console.log('CONFIG: ACE_MAX_POLL_ATTEMPTS =', ACE_MAX_POLL_ATTEMPTS);\n        console.log('================================================');\n\n        // ============================================\n        // LOGGING UTILITIES\n        // ============================================\n        function log(m) {\n            var d = document.getElementById('log');\n            var t = new Date().toLocaleTimeString();\n            var entry = '[' + t + '] ' + m;\n            d.innerHTML = '<div>' + entry + '</div>' + d.innerHTML;\n            console.log('[LOG] ' + entry);\n        }\n\n        function debug(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n            console.log('[DEBUG:' + id + '] ' + m);\n        }\n\n        function result(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n            console.log('[RESULT:' + id + '] ' + m);\n        }\n\n        function getAceData(r) {\n            console.log('[getAceData] Input:', JSON.stringify(r).substring(0, 500));\n            if (r && r.apiResult && r.apiResult.results) {\n                var data = r.apiResult.results[0] || {};\n                console.log('[getAceData] Extracted:', JSON.stringify(data).substring(0, 300));\n                return data;\n            }\n            return r || {};\n        }\n\n        // ============================================\n        // GEOTAB ADD-IN REGISTRATION\n        // ============================================\n        geotab.addin['ace-api-comparison'] = function() {\n            return {\n                initialize: function(api, state, callback) {\n                    console.log('[INIT] ========== STARTING ==========');\n                    log('Add-in v2.1 initialized');\n                    log('Step 1: Loading device cache...');\n                    \n                    api.call('Get', { typeName: 'Device' }, function(devices) {\n                        console.log('[INIT] Loaded', devices.length, 'devices into cache');\n                        devices.forEach(function(d) {\n                            deviceCache[d.id] = d.name || d.id;\n                        });\n                        log('Cached ' + devices.length + ' device names');\n                        \n                        log('Step 2: Running API tests (immediate)...');\n                        runTest1Api(api);\n                        runTest2Api(api);\n                        runTest3Api(api);\n                        \n                        log('Step 3: Starting Ace queries (5s apart)...');\n                        \n                        // Start all Ace queries quickly (2s apart), poll for results\n                        setTimeout(function() {\n                            console.log('[INIT] >>> Starting Ace Test 1');\n                            log('Ace Test 1 starting');\n                            document.getElementById('t1-ace-status').textContent = 'Processing...';\n                            runTest1Ace(api);\n                        }, 100);\n                        \n                        setTimeout(function() {\n                            console.log('[INIT] >>> Starting Ace Test 2');\n                            log('Ace Test 2 starting');\n                            document.getElementById('t2-ace-result').textContent = 'Processing...';\n                            runTest2Ace(api);\n                        }, ACE_STAGGER_DELAY);\n                        \n                        setTimeout(function() {\n                            console.log('[INIT] >>> Starting Ace Test 3');\n                            log('Ace Test 3 starting');\n                            document.getElementById('t3-ace-status').textContent = 'Processing...';\n                            runTest3Ace(api);\n                        }, ACE_STAGGER_DELAY * 2);\n                        \n                    }, function(e) {\n                        console.error('[INIT] Failed to load devices:', e);\n                        log('ERROR: Failed to load device cache');\n                    });\n                    \n                    callback();\n                },\n                focus: function() { console.log('[FOCUS]'); },\n                blur: function() { console.log('[BLUR]'); }\n            };\n        };\n\n        // ============================================\n        // TEST 1: SPEED COMPARISON\n        // ============================================\n        function runTest1Api(api) {\n            console.log('[T1-API] ========== STARTING ==========');\n            var start = Date.now();\n            document.getElementById('t1-api-status').textContent = 'Fetching...';\n\n            api.call('Get', { typeName: 'Device' }, function(devices) {\n                var elapsed = Date.now() - start;\n                console.log('[T1-API] SUCCESS:', devices.length, 'devices in', elapsed, 'ms');\n                \n                document.getElementById('t1-api-status').textContent = devices.length + ' total devices';\n                document.getElementById('t1-api-time').textContent = elapsed + 'ms';\n                debug('t1-debug', 'API returned ' + devices.length + ' Device objects in ' + elapsed + 'ms');\n                debug('t1-debug', 'Sample: ' + (devices[0] ? devices[0].name : 'N/A'));\n                log('Test1 API: ' + devices.length + ' devices in ' + elapsed + 'ms');\n            }, function(e) {\n                console.error('[T1-API] ERROR:', e);\n                document.getElementById('t1-api-status').textContent = 'Error';\n                debug('t1-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        function runTest1Ace(api) {\n            var question = 'How many vehicles are in my fleet?';\n            console.log('[T1-ACE] ========== STARTING ==========');\n            console.log('[T1-ACE] Question:', question);\n            \n            var start = Date.now();\n            aceQuery(api, question, 't1', function(res) {\n                var elapsed = Date.now() - start;\n                console.log('[T1-ACE] SUCCESS in', elapsed, 'ms');\n                console.log('[T1-ACE] Data:', JSON.stringify(res.data));\n                \n                debug('t1-debug', '---');\n                debug('t1-debug', 'Ace completed in ' + Math.round(elapsed/1000) + 's');\n                debug('t1-debug', 'Ace data: ' + JSON.stringify(res.data));\n\n                var count = '--';\n                if (res.data && res.data[0]) {\n                    var keys = Object.keys(res.data[0]);\n                    count = res.data[0][keys[0]];\n                    debug('t1-debug', 'Key: \"' + keys[0] + '\" = ' + count);\n                }\n                document.getElementById('t1-ace-status').textContent = count + ' (\"active\")';\n                document.getElementById('t1-ace-time').textContent = Math.round(elapsed / 1000) + 's';\n                log('Test1 Ace: ' + count + ' in ' + Math.round(elapsed/1000) + 's');\n            }, function(e) {\n                console.error('[T1-ACE] ERROR:', e);\n                document.getElementById('t1-ace-status').textContent = 'Error';\n                debug('t1-debug', 'Ace ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // TEST 2: FRESHNESS COMPARISON\n        // ============================================\n        function formatTimestamp(date) {\n            // Format: YYYY-MM-DD HH:MM (local timezone)\n            var y = date.getFullYear();\n            var m = String(date.getMonth() + 1).padStart(2, '0');\n            var d = String(date.getDate()).padStart(2, '0');\n            var h = String(date.getHours()).padStart(2, '0');\n            var min = String(date.getMinutes()).padStart(2, '0');\n            return y + '-' + m + '-' + d + ' ' + h + ':' + min;\n        }\n\n        function runTest2Api(api) {\n            console.log('[T2-API] ========== STARTING ==========');\n            document.getElementById('t2-api-result').textContent = 'Fetching...';\n            \n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            \n            console.log('[T2-API] Now:', now.toISOString());\n            console.log('[T2-API] From:', fromDate.toISOString());\n            debug('t2-debug', 'API query: Trips from ' + fromDate.toISOString().split('T')[0]);\n\n            api.call('Get', {\n                typeName: 'Trip',\n                search: {\n                    fromDate: fromDate.toISOString(),\n                    toDate: now.toISOString()\n                }\n            }, function(trips) {\n                console.log('[T2-API] Got', trips.length, 'trips');\n                debug('t2-debug', 'API returned ' + trips.length + ' trips');\n\n                if (trips && trips.length > 0) {\n                    trips.sort(function(a, b) {\n                        return new Date(b.stop) - new Date(a.stop);\n                    });\n                    var t = trips[0];\n                    var stopTime = new Date(t.stop);\n                    test2ApiTimestamp = stopTime;  // Store for comparison with Ace\n                    var deviceName = deviceCache[t.device.id] || t.device.id;\n                    var formattedTime = formatTimestamp(stopTime);\n\n                    console.log('[T2-API] Most recent:', t.stop, 'Device:', deviceName);\n                    debug('t2-debug', 'Most recent: ' + deviceName);\n                    debug('t2-debug', 'Stop time: ' + formattedTime);\n                    \n                    document.getElementById('t2-api-result').innerHTML =\n                        '<small>' + deviceName + '</small><br>' +\n                        '<span class=\"text-success fw-bold\">' + formattedTime + '</span>';\n                } else {\n                    document.getElementById('t2-api-result').textContent = 'No trips found';\n                }\n                log('Test2 API: ' + trips.length + ' trips analyzed');\n            }, function(e) {\n                console.error('[T2-API] ERROR:', e);\n                document.getElementById('t2-api-result').textContent = 'Error';\n                debug('t2-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        function runTest2Ace(api) {\n            // Unbounded question to show Ace's data freshness delay\n            var question = 'When was the most recent trip in my fleet? Give me the exact end time and vehicle name.';\n            console.log('[T2-ACE] ========== STARTING ==========');\n            console.log('[T2-ACE] Question:', question);\n            \n            aceQuery(api, question, 't2', function(res) {\n                console.log('[T2-ACE] SUCCESS');\n                console.log('[T2-ACE] Data:', JSON.stringify(res.data));\n                \n                debug('t2-debug', '---');\n                debug('t2-debug', 'Ace data: ' + JSON.stringify(res.data));\n\n                if (res.data && res.data[0]) {\n                    var d = res.data[0];\n                    var name = d.DeviceName || d.vehicleName || d.name || 'Unknown';\n                    var timeStr = d.TripEndDateTime || d.endTime || d.stop || 'Unknown';\n                    \n                    debug('t2-debug', 'Device: ' + name);\n                    debug('t2-debug', 'End time (raw): ' + timeStr);\n                    \n                    // Parse Ace timestamp as UTC (Ace returns UTC with DeviceTimeZoneId: Etc/UTC)\n                    // Add 'Z' suffix if not present to ensure UTC parsing\n                    var utcTimeStr = timeStr;\n                    if (timeStr && !timeStr.endsWith('Z') && !timeStr.includes('+')) {\n                        utcTimeStr = timeStr.replace(' ', 'T') + 'Z';\n                    }\n                    debug('t2-debug', 'Parsed as UTC: ' + utcTimeStr);\n                    var aceTime = new Date(utcTimeStr);\n                    var formattedAceTime = isNaN(aceTime.getTime()) ? timeStr : formatTimestamp(aceTime);\n                    \n                    document.getElementById('t2-ace-result').innerHTML =\n                        '<small>' + name + '</small><br>' +\n                        '<span style=\"color:#b45309;\" class=\"fw-bold\">' + formattedAceTime + '</span>';\n                    \n                    // Show comparison if both timestamps are available\n                    if (test2ApiTimestamp && !isNaN(aceTime.getTime())) {\n                        var diffMs = test2ApiTimestamp.getTime() - aceTime.getTime();\n                        var diffMins = Math.round(diffMs / (1000 * 60));\n                        var diffHours = Math.round(diffMs / (1000 * 60 * 60));\n                        var diffStr;\n                        if (diffMins < 60) {\n                            diffStr = diffMins + ' minutes';\n                        } else if (diffHours < 24) {\n                            diffStr = diffHours + ' hours';\n                        } else {\n                            diffStr = Math.round(diffHours / 24) + ' days';\n                        }\n                        \n                        var compBox = document.getElementById('t2-comparison');\n                        compBox.classList.remove('d-none');\n                        if (diffMs > 0) {\n                            compBox.innerHTML = '<strong style=\"color:#dc2626;\">Ace data is ' + diffStr + ' behind API</strong><br>' +\n                                '<small>API: ' + formatTimestamp(test2ApiTimestamp) + ' vs Ace: ' + formattedAceTime + '</small>';\n                        } else if (diffMs < 0) {\n                            compBox.innerHTML = '<strong style=\"color:#059669;\">Ace shows newer data than API (' + Math.abs(diffMins) + ' min)</strong><br>' +\n                                '<small>This may indicate different vehicles or data sources</small>';\n                        } else {\n                            compBox.innerHTML = '<strong style=\"color:#059669;\">Timestamps match exactly!</strong>';\n                        }\n                        debug('t2-debug', 'Difference: ' + diffStr + ' (' + diffMins + ' min)');\n                        log('Test2: Ace is ' + diffStr + ' behind API');\n                    }\n                } else if (res.reasoning) {\n                    document.getElementById('t2-ace-result').innerHTML = res.reasoning.substring(0, 100) + '...';\n                } else {\n                    document.getElementById('t2-ace-result').textContent = 'No data';\n                }\n                log('Test2 Ace: Got historical data');\n            }, function(e) {\n                console.error('[T2-ACE] ERROR:', e);\n                document.getElementById('t2-ace-result').textContent = 'Error';\n                debug('t2-debug', 'Ace ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // TEST 3: COMPLEX ANALYSIS COMPARISON\n        // ============================================\n        function runTest3Api(api) {\n            console.log('[T3-API] ========== STARTING ==========');\n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); // Last 30 days\n            \n            console.log('[T3-API] From:', fromDate.toISOString());\n            console.log('[T3-API] Now:', now.toISOString());\n            debug('t3-debug', 'API: Trips from ' + fromDate.toISOString().split('T')[0] + ' to ' + now.toISOString().split('T')[0] + ' (30 days)');\n\n            var start = Date.now();\n            document.getElementById('t3-api-status').textContent = 'Fetching...';\n\n            api.call('Get', {\n                typeName: 'Trip',\n                search: {\n                    fromDate: fromDate.toISOString(),\n                    toDate: now.toISOString()\n                }\n            }, function(trips) {\n                var elapsed = Date.now() - start;\n                console.log('[T3-API] Got', trips.length, 'trips in', elapsed, 'ms');\n                \n                debug('t3-debug', 'API: ' + trips.length + ' trips in ' + elapsed + 'ms');\n\n                console.log('[T3-API] Aggregating by device...');\n                var byDevice = {};\n                var totalMeters = 0;\n                trips.forEach(function(trip) {\n                    var deviceId = trip.device.id;\n                    var dist = trip.distance || 0;\n                    totalMeters += dist;\n                    if (!byDevice[deviceId]) {\n                        byDevice[deviceId] = { \n                            id: deviceId, \n                            name: deviceCache[deviceId] || deviceId,\n                            distance: 0, \n                            trips: 0 \n                        };\n                    }\n                    byDevice[deviceId].distance += dist;\n                    byDevice[deviceId].trips++;\n                });\n\n                var sorted = Object.values(byDevice).sort(function(a, b) {\n                    return b.distance - a.distance;\n                });\n                var top3 = sorted.slice(0, 3);\n                \n                console.log('[T3-API] Total distance:', totalMeters, 'meters =', (totalMeters/1609.34).toFixed(1), 'miles');\n                console.log('[T3-API] Aggregated to', sorted.length, 'devices');\n                console.log('[T3-API] Top 3:', JSON.stringify(top3));\n\n                result('t3-api-result', '=== API Results (JS aggregation) ===');\n                result('t3-api-result', trips.length + ' trips -> ' + sorted.length + ' devices');\n                result('t3-api-result', 'Total: ' + (totalMeters/1609.34).toFixed(1) + ' miles');\n                result('t3-api-result', '---');\n                top3.forEach(function(d, i) {\n                    var miles = (d.distance / 1609.34).toFixed(1);\n                    result('t3-api-result', (i + 1) + '. ' + d.name + ': ' + miles + ' mi (' + d.trips + ' trips)');\n                });\n\n                document.getElementById('t3-api-status').textContent = sorted.length + ' devices';\n                document.getElementById('t3-api-time').textContent = elapsed + 'ms, ' + trips.length + ' trips';\n                log('Test3 API: ' + trips.length + ' trips in ' + elapsed + 'ms');\n            }, function(e) {\n                console.error('[T3-API] ERROR:', e);\n                document.getElementById('t3-api-status').textContent = 'Error';\n                debug('t3-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        function runTest3Ace(api) {\n            // Match API's date range: last 30 days\n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            var fromStr = fromDate.toISOString().split('T')[0];\n            var toStr = now.toISOString().split('T')[0];\n            var question = 'What are the top 3 vehicles by total distance traveled from ' + fromStr + ' to ' + toStr + '? Show vehicle name and distance in miles.';\n            console.log('[T3-ACE] ========== STARTING ==========');\n            console.log('[T3-ACE] Question:', question);\n            \n            var start = Date.now();\n\n            aceQuery(api, question, 't3', function(res) {\n                var elapsed = Date.now() - start;\n                console.log('[T3-ACE] SUCCESS in', elapsed, 'ms');\n                console.log('[T3-ACE] Data:', JSON.stringify(res.data));\n                \n                debug('t3-debug', '---');\n                debug('t3-debug', 'Ace completed in ' + Math.round(elapsed/1000) + 's');\n\n                result('t3-ace-result', '=== Ace Results (pre-analyzed) ===');\n\n                if (res.data && res.data.length > 0) {\n                    console.log('[T3-ACE] Got', res.data.length, 'rows');\n                    res.data.forEach(function(row, i) {\n                        var name = row.DeviceName || row.vehicleName || row.name || 'Unknown';\n                        var dist = row.Distance_mi || row.distance || row.totalDistance || '?';\n                        result('t3-ace-result', (i + 1) + '. ' + name + ': ' + dist + ' mi');\n                        result('t3-ace-result', '   Raw: ' + JSON.stringify(row));\n                    });\n                } else {\n                    result('t3-ace-result', 'No data returned');\n                }\n\n                if (res.reasoning) {\n                    result('t3-ace-result', '---');\n                    result('t3-ace-result', 'Reasoning: ' + res.reasoning.substring(0, 150) + '...');\n                }\n\n                document.getElementById('t3-ace-status').textContent = 'Done';\n                document.getElementById('t3-ace-time').textContent = Math.round(elapsed / 1000) + 's';\n                log('Test3 Ace: completed in ' + Math.round(elapsed/1000) + 's');\n            }, function(e) {\n                console.error('[T3-ACE] ERROR:', e);\n                document.getElementById('t3-ace-status').textContent = 'Error';\n                debug('t3-debug', 'Ace ERROR: ' + e);\n                result('t3-ace-result', 'ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // ACE QUERY HELPER\n        // ============================================\n        function aceQuery(api, question, testId, onSuccess, onError) {\n            console.log('[ACE:' + testId + '] ========== QUERY START ==========');\n            console.log('[ACE:' + testId + '] Question:', question);\n            log('Ace [' + testId + ']: Sending \"' + question.substring(0, 40) + '...\"');\n\n            // Retry wrapper for create-chat\n            function tryCreateChat(attempt) {\n                console.log('[ACE:' + testId + '] Step 1: create-chat (attempt ' + (attempt + 1) + '/' + ACE_CREATE_CHAT_RETRIES + ')');\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'create-chat',\n                    functionParameters: {}\n                }, function(r) {\n                    console.log('[ACE:' + testId + '] create-chat response:', JSON.stringify(r).substring(0, 400));\n                    var d = getAceData(r);\n                    var chatId = d.chat_id;\n\n                    if (!chatId) {\n                        console.error('[ACE:' + testId + '] NO CHAT_ID on attempt', attempt + 1);\n                        if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {\n                            log('Ace [' + testId + ']: Retrying create-chat in ' + (ACE_RETRY_DELAY/1000) + 's...');\n                            setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);\n                        } else {\n                            onError('No chat_id after ' + ACE_CREATE_CHAT_RETRIES + ' attempts');\n                        }\n                        return;\n                    }\n                    onChatCreated(chatId);\n                }, function(e) {\n                    console.error('[ACE:' + testId + '] create-chat FAILED on attempt', attempt + 1, ':', e);\n                    if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {\n                        log('Ace [' + testId + ']: Retrying create-chat in ' + (ACE_RETRY_DELAY/1000) + 's...');\n                        setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);\n                    } else {\n                        onError('create-chat failed after ' + ACE_CREATE_CHAT_RETRIES + ' attempts: ' + JSON.stringify(e));\n                    }\n                });\n            }\n\n            function onChatCreated(chatId) {\n                console.log('[ACE:' + testId + '] chat_id:', chatId);\n                log('Ace [' + testId + ']: Got chat_id');\n\n                console.log('[ACE:' + testId + '] Step 2: send-prompt');\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'send-prompt',\n                    functionParameters: {\n                        chat_id: chatId,\n                        prompt: question\n                    }\n                }, function(r2) {\n                    console.log('[ACE:' + testId + '] send-prompt response:', JSON.stringify(r2).substring(0, 400));\n                    var d2 = getAceData(r2);\n                    var mgId = d2.message_group_id || ((d2.message_group || {}).id);\n\n                    if (!mgId) {\n                        console.error('[ACE:' + testId + '] NO MESSAGE_GROUP_ID!');\n                        onError('No message_group_id');\n                        return;\n                    }\n                    console.log('[ACE:' + testId + '] message_group_id:', mgId);\n                    log('Ace [' + testId + ']: Got message_group_id, polling...');\n\n                    console.log('[ACE:' + testId + '] Step 3: Waiting', ACE_INITIAL_POLL_DELAY, 'ms then polling');\n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, 0);\n                    }, ACE_INITIAL_POLL_DELAY);\n                }, function(e) {\n                    console.error('[ACE:' + testId + '] send-prompt FAILED:', e);\n                    onError('send-prompt: ' + JSON.stringify(e));\n                });\n            }\n\n            // Start the retry chain\n            tryCreateChat(0);\n        }\n\n        function pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt) {\n            console.log('[POLL:' + testId + '] Attempt', attempt + 1, '/', ACE_MAX_POLL_ATTEMPTS);\n            \n            if (attempt >= ACE_MAX_POLL_ATTEMPTS) {\n                console.error('[POLL:' + testId + '] TIMEOUT!');\n                onError('Timeout after ' + attempt + ' attempts');\n                return;\n            }\n\n            log('Ace [' + testId + ']: Poll #' + (attempt + 1));\n\n            api.call('GetAceResults', {\n                serviceName: 'dna-planet-orchestration',\n                functionName: 'get-message-group',\n                functionParameters: {\n                    chat_id: chatId,\n                    message_group_id: mgId\n                }\n            }, function(r) {\n                console.log('[POLL:' + testId + '] Response:', JSON.stringify(r).substring(0, 600));\n                var d = getAceData(r);\n                var mg = d.message_group || {};\n                var st = mg.status ? mg.status.status : 'UNKNOWN';\n\n                console.log('[POLL:' + testId + '] Status:', st);\n\n                if (st === 'DONE') {\n                    console.log('[POLL:' + testId + '] DONE!');\n                    var msgs = mg.messages || {};\n                    var res = { data: null, reasoning: null };\n                    var keys = Object.keys(msgs);\n\n                    console.log('[POLL:' + testId + '] Messages:', keys.length);\n                    keys.forEach(function(k) {\n                        var m = msgs[k];\n                        console.log('[POLL:' + testId + '] Message', k, '- preview_array:', !!m.preview_array, ', reasoning:', !!m.reasoning);\n                        if (m.preview_array) {\n                            res.data = m.preview_array;\n                            console.log('[POLL:' + testId + '] preview_array:', JSON.stringify(res.data).substring(0, 300));\n                        }\n                        if (m.reasoning) {\n                            res.reasoning = m.reasoning;\n                        }\n                    });\n\n                    onSuccess(res);\n                } else if (st === 'FAILED') {\n                    var errMsg = mg.status.message || 'Unknown';\n                    console.error('[POLL:' + testId + '] FAILED:', errMsg);\n                    onError('FAILED: ' + errMsg);\n                } else {\n                    console.log('[POLL:' + testId + '] Not done, retry in', ACE_POLL_INTERVAL, 'ms');\n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                    }, ACE_POLL_INTERVAL);\n                }\n            }, function(e) {\n                console.error('[POLL:' + testId + '] ERROR:', e);\n                setTimeout(function() {\n                    pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                }, ACE_POLL_INTERVAL);\n            });\n        }\n\n        console.log('Ace vs API Comparison v2.1 loaded, waiting for geotab.addin init...');\n    </script>\n</body>\n</html>\n"
  }
}
